{namespace f=TYPO3\CMS\Fluid\ViewHelpers}

<f:spaceless>
    <nav class="c-menu js-menu" aria-label="Hauptnavigation" data-menu-root>
        <!-- Öffnen-Toggle (Burger) -->
        <button class="c-menu__toggle" type="button" aria-controls="primary-menu-wrapper" aria-expanded="false" data-menu-toggle>
            <span aria-hidden="true"></span>
            <span class="u-visually-hidden">Menü</span>
        </button>

        <!-- Overlay-Wrapper (mobil) -->
        <div id="primary-menu-wrapper" class="c-menu__wrapper" data-menu-wrapper>

            <!-- Overlay-Header mit Titel + Schließen -->
            <div class="c-menu__head">
                <h2 class="c-menu__title">Menü</h2>
                <button class="c-menu__close" type="button" aria-controls="primary-menu-wrapper" aria-expanded="true" aria-label="Menü schließen" data-menu-toggle>
                    <span aria-hidden="true"></span>
                    <span class="u-visually-hidden">Schließen</span>
                </button>
            </div>

            <!-- Home-Link (nur mobil sichtbar via CSS) -->
            <f:variable name="homeUid" value="{homePageUid}" />
            <f:if condition="{homeUid}"><f:then /><f:else><f:variable name="homeUid" value="{site.rootPageId}" /></f:else></f:if>

            <ul class="c-menu__list" role="list">
                <li class="c-menu__item c-menu__home">
                    <a href="{f:uri.page(pageUid: homeUid)}" class="c-menu__link">Startseite</a>
                </li>

                <f:for each="{menuMain}" as="item">
                    <f:variable name="itemId" value="{f:if(condition:item.data.uid, then:item.data.uid, else:item.uid)}" />

                    <li class="c-menu__item{f:if(condition:item.children, then:' has-submenu')}{f:if(condition:item.active, then:' is-active')}{f:if(condition:item.current, then:' is-active')}"
                        {f:if(condition:item.children, then:'data-has-submenu="true"')}
                    data-mega-item="{itemId}">

                    <f:if condition="{item.children}">
                        <f:then>
                            <!-- Ebene 1 (Parent) -->
                            <a href="{item.link}"
                               class="c-menu__link js-menu-parent{f:if(condition:item.active, then:' is-active')}{f:if(condition:item.current, then:' is-active')}"
                               aria-haspopup="true"
                               aria-expanded="false"
                               aria-controls="submenu-{itemId}"
                               data-menu-parent="true"
                               data-mega-trigger="{itemId}">{item.title}</a>

                            <!-- Drill (mobil) -->
                            <button class="c-menu__drill" type="button" aria-label="Ebene öffnen" data-menu-drill="submenu-{itemId}"></button>

                            <!-- Desktop: Mega-Panel -->
                            <section id="panel-{itemId}" class="c-menu__panel" role="region" aria-label="{item.title}" data-mega-panel="{itemId}">
                                <div class="c-menu__panel-inner">
                                    <nav class="c-menu__panel-nav" aria-label="{item.title} – Untermenü">
                                        <ul class="c-menu__panel-list" role="list">
                                            <f:for each="{item.children}" as="child">
                                                <f:variable name="childId" value="{f:if(condition:child.data.uid, then:child.data.uid, else:child.uid)}" />
                                                <li class="c-menu__panel-item{f:if(condition:child.active, then:' is-active')}">
                                                    <a href="{child.link}" class="c-menu__panel-link{f:if(condition:child.active, then:' is-active')}">{child.title}</a>

                                                    <!-- Ebene 3 im Panel -->
                                                    <f:if condition="{child.children}">
                                                        <ul class="c-menu__panel-sublist" role="list">
                                                            <f:for each="{child.children}" as="grandchild">
                                                                <f:variable name="grandId" value="{f:if(condition:grandchild.data.uid, then:grandchild.data.uid, else:grandchild.uid)}" />
                                                                <li class="c-menu__panel-subitem{f:if(condition:grandchild.active, then:' is-active')}">
                                                                    <a href="{grandchild.link}" class="c-menu__panel-sublink{f:if(condition:grandchild.active, then:' is-active')}">{grandchild.title}</a>
                                                                </li>
                                                            </f:for>
                                                        </ul>
                                                    </f:if>
                                                </li>
                                            </f:for>
                                        </ul>
                                    </nav>

                                    <!-- Rechte Spalte (optional) -->
                                    <div class="c-menu__panel-content">
                                        <f:if condition="{item.abstract}"><p class="c-menu__panel-text">{item.abstract}</p></f:if>
                                        <f:if condition="{item.media.0.publicUrl}"><img src="{item.media.0.publicUrl}" alt="" class="c-menu__panel-image" /></f:if>
                                    </div>
                                </div>
                            </section>

                            <!-- Mobil: Akkordeon (Ebene 2 + 3) -->
                            <div class="c-menu__submenu" role="group" id="submenu-{itemId}" data-menu-submenu>
                                <ul class="c-menu__submenu-list" role="list">
                                    <f:for each="{item.children}" as="child">
                                        <f:variable name="childId" value="{f:if(condition:child.data.uid, then:child.data.uid, else:child.uid)}" />
                                        <li class="c-menu__item{f:if(condition:child.children, then:' has-submenu')}"
                                            {f:if(condition:child.children, then:'data-has-submenu="true"')}>
                                        <f:if condition="{child.children}">
                                            <f:then>
                                                <a href="{child.link}"
                                                   class="c-menu__link js-menu-parent"
                                                   aria-haspopup="true"
                                                   aria-expanded="false"
                                                   aria-controls="subsubmenu-{childId}"
                                                   data-menu-parent="true">{child.title}</a>
                                                <button class="c-menu__drill" type="button" aria-label="Ebene öffnen" data-menu-drill="subsubmenu-{childId}"></button>

                                                <div id="subsubmenu-{childId}" class="c-menu__submenu" role="group" data-menu-submenu>
                                                    <f:for each="{child.children}" as="grandchild">
                                                        <a href="{grandchild.link}" class="c-menu__submenu-link">{grandchild.title}</a>
                                                    </f:for>
                                                </div>
                                            </f:then>
                                            <f:else>
                                                <a href="{child.link}" class="c-menu__submenu-link">{child.title}</a>
                                            </f:else>
                                        </f:if>
                                        </li>
                                    </f:for>
                                </ul>
                            </div>
                        </f:then>

                        <!-- Ebene 1 ohne Kinder -->
                        <f:else>
                            <a href="{item.link}" class="c-menu__link{f:if(condition:item.active, then:' is-active')}{f:if(condition:item.current, then:' is-active')}">{item.title}</a>
                        </f:else>
                    </f:if>
                    </li>
                </f:for>
            </ul>

            <!-- CTA (nur mobil sichtbar via CSS) -->
            <f:variable name="ctaLabel" value="{ctaPublicLabel}" />
            <f:if condition="{ctaLabel}"><f:then /><f:else><f:variable name="ctaLabel" value="{settings.ctaPublic.label}" /></f:else></f:if>
            <f:if condition="{ctaLabel}"><f:then /><f:else><f:variable name="ctaLabel" value="Öffentliche Seminartermine" /></f:else></f:if>

            <f:variable name="ctaPid" value="{ctaPublicPageUid}" />
            <f:if condition="{ctaPid}"><f:then /><f:else><f:variable name="ctaPid" value="{settings.ctaPublic.pageUid}" /></f:else></f:if>
            <f:if condition="{ctaPid}"><f:then /><f:else><f:variable name="ctaPid" value="25" /></f:else></f:if>

            <a href="{f:uri.page(pageUid: ctaPid)}" class="c-menu__cta" title="{ctaLabel}">{ctaLabel}</a>
        </div>
    </nav>
</f:spaceless>
