// ======================================================
// components/_c-menu.scss
// Hauptnavigation – Mobil Overlay, Desktop Mega-Panel
// ======================================================

@use "sass:meta";
@use "sass:color";
@use "globals" as *;

$__primary: if(meta.global-variable-exists(color-primary), $color-primary, #00ac80);
$__primary-strong: color.scale($__primary, $lightness: -6%);
$__focus-ring: if(meta.global-variable-exists(color-focus), $color-focus, color.scale($__primary, $lightness: +20%));
$__text: if(meta.global-variable-exists(color-text), $color-text, #1a1a1a);
$__text-light: if(meta.global-variable-exists(color-text-light), $color-text-light, #6c757d);
$__shadow-soft: if(meta.global-variable-exists(shadow-soft), $shadow-soft, 0 8px 24px rgba(0,0,0,.18));
$__divider: rgba(0,0,0,.08);
$__surface: if(meta.global-variable-exists(color-surface), $color-surface, #fff);

$__bp-desktop: 1230px;
$__bp-mobile-max: 1229px;

.u-visually-hidden {
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0 0 0 0);
  white-space: nowrap; border: 0;
}

.c-menu {
  position: relative;

  /* Hamburger-Toggle */
  &__toggle {
    display: inline-flex; align-items: center; justify-content: center;
    width: 32px; height: 24px; background: none; border: 0; cursor: pointer;
    position: relative; z-index: 1005; pointer-events: auto; -webkit-tap-highlight-color: transparent; touch-action: manipulation;

    span,
    span::before,
    span::after {
      content: ''; position: absolute; display: block; width: 100%; height: 3px; left: 0; border-radius: 2px; background-color: $__text;
      transition: transform .3s ease, opacity .3s ease, top .3s ease, bottom .3s ease, background-color .3s ease;
    }
    span { top: 50%; transform: translateY(-50%); }
    span::before { top: -8px; }
    span::after  { bottom: -8px; }

    &.is-active { span { background-color: transparent; } span::before { top: 0; transform: rotate(45deg); } span::after { bottom: 0; transform: rotate(-45deg); } }

    &:focus-visible { outline: 2px solid $__focus-ring; outline-offset: 3px; border-radius: 8px; }
  }

  /* --- Overlay (mobil) --- */
  &__wrapper {
    display: flex; flex-direction: column; align-items: stretch; background-color: $__surface; padding: 0; border-radius: 0;
    position: fixed; inset: 0; z-index: 1003; overflow: auto;
    opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-2%);
    transition: opacity .22s ease, transform .22s ease, visibility 0s linear .22s;

    &.is-open { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0); transition: opacity .22s ease, transform .22s ease, visibility 0s; }
  }

  &__head {
    position: sticky; top: 0; z-index: 1;
    display: grid; grid-template-columns: 1fr auto; align-items: center; gap: .5rem;
    padding: .9rem 1rem; background: $__surface;
  }

  &__title { margin: 0; font-size: 1.125rem; font-weight: if(meta.global-variable-exists(font-weight-semibold), $font-weight-semibold, 600); letter-spacing: .01em; }

  /* Close-Button im mobilen Kopf */
  &__close {
    appearance: none;
    background: none;
    border: 0;
    padding: .25rem .25rem;
    margin: 0;
    cursor: pointer;
    color: inherit;
    font: inherit;
    text-transform: uppercase;
    letter-spacing: .06em;
    font-weight: if(meta.global-variable-exists(font-weight-semibold), $font-weight-semibold, 600);
    justify-self: end;

    &:hover,
    &:focus { text-decoration: underline; }

    &:focus-visible {
      outline: 2px solid $__focus-ring;
      outline-offset: 3px;
      border-radius: 6px;
    }
  }

  &__list {
    list-style: none; margin: 0 0 1rem; padding: 0 1rem; display: flex; flex-direction: column; width: 100%;
    background: $__surface; gap: 0;
  }

  &__item { position: relative; }

  &__link {
    display: block; color: $__text; text-decoration: none;
    font-weight: if(meta.global-variable-exists(font-weight-semibold), $font-weight-semibold, 600);
    text-transform: uppercase; letter-spacing: .03em; padding: 1rem 0; line-height: 1.2; transition: color .2s ease;

    &:hover, &:focus { color: $__primary; text-decoration: none; }
    &:focus-visible { outline: 2px solid $__focus-ring; outline-offset: 6px; border-radius: 6px; }
  }

  /* Drill-Button – sichtbar & robust */
  &__drill {
    appearance: none;
    position: absolute; right: .25rem; top: 50%; transform: translateY(-50%);
    width: 34px; height: 34px; border-radius: 999px;
    background: $__surface;
    border: 1px solid $__divider; /* sichtbarer 1px-Ring */
    cursor: pointer;
    display: inline-grid; place-items: center;
    transition: transform .15s ease;
    z-index: 2;
    -webkit-tap-highlight-color: transparent;
    outline: none;

    /* Backplate (löscht Fremdringe hinter dem Button) */
    &::before {
      content: ""; position: absolute; inset: -3px; background: $__surface; border-radius: 999px; z-index: -1;
    }

    /* Chevron */
    &::after {
      content: ""; position: absolute; top: 50%; left: 50%;
      width: 8px; height: 8px;
      border-right: 2px solid $__text; border-bottom: 2px solid $__text;
      transform: translate(-50%, -50%) rotate(-45deg);
    }

    &:hover, &:focus { transform: translateY(-50%) #{'scale(0.98)'}; }
    &:active { transform: translateY(-50%) #{'scale(0.96)'}; }

    &:focus-visible { box-shadow: 0 0 0 2px $__focus-ring; }
  }

  /* Falls doch doppelt vorhanden, alle außer dem ersten ausblenden */
  &__item > &__drill ~ &__drill { display: none !important; }

  /* Submenu-Block */
  &__submenu {
    display: none; flex-direction: column; padding: .25rem 0 .75rem 0; margin: 0;

    .c-menu__submenu-link {
      display: block; color: $__text-light; text-decoration: none; padding: .5rem 0 .5rem 1rem; transition: color .15s ease;
      &:hover, &:focus { color: $__primary; }
      &:focus-visible { outline: 2px solid $__focus-ring; outline-offset: 4px; border-radius: 4px; }
    }

    .c-menu__submenu & {
      padding-left: 1rem;
      .c-menu__submenu-link { padding-left: 1.5rem; font-size: 0.95em; }
    }
  }

  /* Mega-Panel mobil NIE anzeigen */
  &__panel { display: none; }

  /* --- Desktop: Mega-Panel & grünes Overlay --- */
  @media (min-width: $__bp-desktop) {
    &__toggle { display: none; }

    &__wrapper { display: block !important; position: static; background: transparent; padding: 0; opacity: 1; visibility: visible; pointer-events: auto; transform: none; transition: none; overflow: visible; }
    &__list { flex-direction: row; align-items: center; gap: 2rem; width: auto; margin: 0; padding: 0; background: transparent; }
    &__link { padding: 0; } /* Top-Level-Links bleiben neutral */
    &__drill, &__head, &__close { display: none; }

    .c-menu__item.has-submenu > .c-menu__link { padding-right: 0; }

    &__panel {
      display: block; position: fixed; left: 0; right: 0; top: var(--header-bottom, 0px);
      background: #fff; box-shadow: $__shadow-soft; z-index: 1002;
      opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-6px);
      transition: background-color .18s ease, opacity .18s ease, transform .18s ease, visibility 0s linear .18s;
    }

    /* Panel sichtbar */
    &__item.is-mega-open > &__panel {
      opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0);
      background-color: $__primary; /* <<< Grün wie gewünscht */
      transition: background-color .18s ease, opacity .18s ease, transform .18s ease, visibility 0s;
    }

    /* Panel-Inhalte auf Weiß drehen */
    &__panel-inner {
      max-width: if(meta.global-variable-exists(max-header-width), $max-header-width, 1200px);
      margin: 0 auto; padding: 1.25rem 1rem 1.5rem;

      /* Grid: linke Spalte 360px für Bild/Teaser, rechte flexibel */
      display: grid; grid-template-columns: 360px 1fr; gap: 2rem;
    }

    /* Typo-Farbe im grünen Panel */
    &__item.is-mega-open > &__panel .c-menu__panel-inner { color: #fff; }

    &__panel-list { list-style: none; margin: 0; padding: 0; display: grid; gap: .5rem; }

    &__panel-link {
      display: block; text-decoration: none; padding: .35rem 0;
      font-weight: if(meta.global-variable-exists(font-weight-medium), $font-weight-medium, 600);
      transition: color .15s ease;
      color: $__text; /* Standard (wenn Panel weiß) */
    }
    /* Im grünen Panel: Links weiß + Unterstreichung beim Hover */
    &__item.is-mega-open > &__panel .c-menu__panel-link {
      color: #fff;
    }
    &__item.is-mega-open > &__panel .c-menu__panel-link:hover,
    &__item.is-mega-open > &__panel .c-menu__panel-link:focus {
      color: #fff; text-decoration: underline; text-decoration-thickness: .08em; text-underline-offset: .18em;
    }

    &__panel-sublist { list-style: none; margin: .25rem 0 .75rem; padding: 0 0 0 .75rem; display: grid; gap: .25rem; }
    &__panel-subitem { margin: 0; padding: 0; }

    &__panel-sublink {
      display: inline-block; text-decoration: none; padding: .15rem 0 .15rem .25rem; line-height: 1.35; transition: color .15s ease, transform .15s ease;
      color: $__text-light; /* Standard (wenn Panel weiß) */
    }
    /* Im grünen Panel: Sub-Links heller/weiß */
    &__item.is-mega-open > &__panel .c-menu__panel-sublink { color: rgba(255,255,255,.85); }
    &__item.is-mega-open > &__panel .c-menu__panel-sublink:hover,
    &__item.is-mega-open > &__panel .c-menu__panel-sublink:focus {
      color: #fff; text-decoration: underline; text-underline-offset: .14em;
      transform: translateX(1px);
    }

    &__panel-content {
      display: grid; gap: .75rem; align-content: start; color: rgba(0,0,0,.6); font-size: .98rem; line-height: 1.55;
    }
    /* Im grünen Panel: Content-Typo auf Weiß */
    &__item.is-mega-open > &__panel .c-menu__panel-content { color: rgba(255,255,255,.9); }

    /* Mega-Panel: Bildgröße zähmen (Variante: einpassen, ohne Beschnitt) */
    &__panel-image {
      display: block;
      width: 100%;
      height: auto;
      max-height: #{'clamp(180px, 28vh, 320px)'}; /* Interpolation verhindert Sass-Berechnung */
      object-fit: contain;                      /* nie beschneiden */
    }

    /* Alternative (Teaser-Beschnitt):
    &__panel-image {
      display: block;
      width: 100%;
      height: 220px;
      object-fit: cover;
    } */
  }
}

/* CTA im Overlay: sichtbar nur mobil */
.c-menu__cta {
  display: inline-flex; align-items: center; justify-content: center;
  width: calc(100% - 2rem); margin: .25rem 1rem 1rem; padding: 1rem 1.25rem;
  background-color: $__primary; color: #fff; text-decoration: none;
  font-weight: if(meta.global-variable-exists(font-weight-semibold), $font-weight-semibold, 600);
  text-transform: uppercase; letter-spacing: .04em; border-radius: 0;
  box-shadow: 0 6px 18px rgba(0,0,0,.08);
  transition: background-color .2s ease, transform .15s ease, box-shadow .2s ease;

  &:hover, &:focus { background-color: $__primary-strong; transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.12); text-decoration: none; }
}

/* Desktop: CTA im Menü sicher ausblenden (höhere Spezifität) */
@media (min-width: $__bp-desktop) {
  nav.c-menu .c-menu__cta { display: none !important; }
}

/* Motion-Preferences */
@media (prefers-reduced-motion: reduce) {
  .c-menu__wrapper { transition: none !important; transform: none !important; }
  .c-menu__panel { transition: none !important; transform: none !important; }
  .c-menu__drill { transition: none !important; }
}

/* -------------------- MOBIL-SCHICHT -------------------- */
@media (max-width: $__bp-mobile-max) {
  .c-menu > .c-menu__toggle { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
  .c-menu__item.has-submenu > .c-menu__link { padding-right: 2.25rem; }

  /* Kill mögliche fremde Pseudo-Indikatoren am Link (häufige Ursache für Doppelkreise) */
  .c-menu__item.has-submenu > .c-menu__link::before,
  .c-menu__item.has-submenu > .c-menu__link::after {
    content: none !important;
  }

  /* Link-Outlines im Overlay abschalten – Drill übernimmt Interaktion */
  .c-menu__link:focus,
  .c-menu__link:focus-visible {
    outline: none !important;
    box-shadow: none !important;
  }

  /* Sicherheit: Keine Ränder am Link/Item im Overlay */
  .c-menu__item,
  .c-menu__link {
    border: 0 !important;
  }
}

/* Startseite-Link nur mobil anzeigen */
@media (min-width: 1230px) {
  .c-menu__home { display: none !important; }
}
